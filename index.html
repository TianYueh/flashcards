<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>å–®å­—å¡ PWA</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#2b7cff">
<style>
  :root{--bg:#f6f8fb;--card:#fff;--accent:#2b7cff;--muted:#666;}
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:#111;}
  header{background:var(--accent);color:#fff;padding:14px 16px;}
  header h1{margin:0;font-size:18px;}
  .app{display:flex;flex-direction:column;height:calc(100vh - 56px);}
  .main{display:flex;flex:1;gap:12px;padding:12px;}
  .col{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
  .left{flex:1;min-width:160px;max-width:360px;display:flex;flex-direction:column;}
  .right{flex:2;display:flex;flex-direction:column;}
  .list{flex:1;overflow:auto;margin-bottom:8px;}
  .card-item{padding:8px;border-radius:8px;cursor:pointer;margin-bottom:6px;border:1px solid rgba(0,0,0,0.04);}
  .card-item.small{font-size:13px;color:var(--muted);}
  .controls{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;}
  button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;font-weight:600;cursor:pointer;}
  button.ghost{background:#eef4ff;color:var(--accent);font-weight:600;border:1px solid rgba(43,124,255,0.12);}
  label{display:block;font-size:13px;margin-top:8px;color:var(--muted)}
  input[type="text"],textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e0e6ef;margin-top:6px;font-size:14px}
  textarea{resize:vertical}
  .detail{overflow:auto;flex:1}
  .prompt{background:#f2f6ff;padding:10px;border-radius:8px;margin-bottom:8px}
  .status{font-size:13px;color:var(--muted);margin-top:8px}
  .center{display:flex;gap:8px;align-items:center}
  footer{padding:8px 12px;font-size:13px;color:var(--muted);text-align:center}
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;padding:16px}
  #modalInner{background:#fff;border-radius:12px;padding:12px;max-width:680px;width:100%;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
  .modal-row{margin-top:8px}
  .q-prompt{white-space:pre-wrap;background:#fafcff;padding:10px;border-radius:8px;margin-bottom:6px}
  @media(max-width:720px){.main{flex-direction:column;padding:10px}.left{max-width:none}}
</style>
</head>
<body>
<header><h1>å–®å­—å¡ Appï¼ˆPWAï¼‰</h1></header>
<div class="app">
  <div class="main">
    <div class="col left">
      <div class="controls">
        <button id="btnCreate">å»ºç«‹å–®å­—</button>
        <button id="btnSentence" class="ghost">æ–°å¢ä¾‹å¥</button>
        <button id="btnTest" class="ghost">é–‹å§‹æ¸¬é©—</button>
      </div>
      <div class="list" id="cardsList" aria-label="å–®å­—æ¸…å–®"></div>
      <div class="status" id="status"></div>
    </div>

    <div class="col right">
      <div id="detailArea" class="detail">
        <div class="prompt"><strong>ä½¿ç”¨èªªæ˜ï¼š</strong> é»é¸å·¦å´å¡ç‰‡æª¢è¦–èˆ‡ç®¡ç†ã€‚å»ºç«‹æˆ–æ–°å¢ä¾‹å¥å¾Œæœƒè‡ªå‹•å„²å­˜ã€‚æ¸¬é©—é¡Œå‹éš¨æ©Ÿï¼šå–®å­—â†’è§£é‡‹ã€è§£é‡‹â†’å–®å­—ã€ä¾‹å¥é®è”½ã€‚ç­”éŒ¯æœƒæ‰£ 1 åˆ†ï¼ˆå¯ç‚ºè² ï¼‰ï¼Œç­”å°é” 5 æ¬¡æœƒåˆªé™¤è©²å¡ã€‚</div>
        <div id="detailContent"></div>
      </div>
      <div style="margin-top:10px" class="center">
        <button id="btnExport" class="ghost">åŒ¯å‡º JSON</button>
        <button id="btnImport" class="ghost">åŒ¯å…¥ JSON</button>
        <button id="btnClear" class="ghost">æ¸…ç©ºæ‰€æœ‰</button>
      </div>
    </div>
  </div>

  <!-- æ¸¬é©— modal -->
  <div id="testModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:16px">
    <div style="background:#fff;border-radius:12px;padding:12px;max-width:680px;width:100%;box-shadow:0 8px 24px rgba(0,0,0,0.3)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>æ¸¬é©—æ¨¡å¼</strong>
        <button id="endTestBtn" class="ghost">çµæŸæ¸¬é©—</button>
      </div>
      <div class="q-prompt" id="qPrompt">é¡Œç›®æœƒå‡ºç¾åœ¨é€™è£¡</div>
      <input id="qAnswer" type="text" placeholder="è¼¸å…¥ç­”æ¡ˆå¾ŒæŒ‰æäº¤" />
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="submitAnswer">æäº¤ç­”æ¡ˆ</button>
        <button id="skipAnswer" class="ghost">è·³é</button>
      </div>
      <div style="margin-top:8px;color:#666" id="testStatus"></div>
    </div>
  </div>

  <footer>åŠ å…¥ä¸»ç•«é¢å¯é›¢ç·šä½¿ç”¨ã€‚è³‡æ–™å„²å­˜åœ¨ä½ çš„è£ç½®ã€‚</footer>
</div>

<script>
const STORAGE_KEY='flashcards_v1';
const MAX_CORRECT=5;
let cards=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(cards));}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
const listEl=document.getElementById('cardsList');
const detailContent=document.getElementById('detailContent');
const status=document.getElementById('status');
let selected=null;
function refresh(){
  listEl.innerHTML='';
  cards.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='card-item';
    el.innerHTML=`<div><strong>${escapeHtml(c.word)}</strong> (${c.correct||0})<div class="small">${escapeHtml(c.meaning)}</div></div>`;
    el.onclick=()=>{selected=i;showDetail(c);highlight();};
    listEl.appendChild(el);
  });
  status.textContent=`å…±æœ‰ ${cards.length} å¼µå¡`;
  save();
}
function highlight(){Array.from(listEl.children).forEach((el,i)=>el.style.border=i===selected?'1px solid var(--accent)':'1px solid rgba(0,0,0,0.04)');}
function showDetail(c){
  let html=`<h3>${escapeHtml(c.word)} <small>(ç­”å°:${c.correct||0})</small></h3>`;
  html+=`<p><strong>è§£é‡‹ï¼š</strong>${escapeHtml(c.meaning)}</p>`;
  if(c.sentences?.length){
    html+='<ol>'+c.sentences.map(s=>`<li>${escapeHtml(s.text)} (pos=${s.pos})</li>`).join('')+'</ol>';
  }else html+='<p style="color:#888">ç„¡ä¾‹å¥</p>';
  html+=`<button id="delBtn" class="ghost">åˆªé™¤æ­¤å¡</button>`;
  detailContent.innerHTML=html;
  document.getElementById('delBtn').onclick=()=>{if(confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')){cards.splice(selected,1);selected=null;refresh();detailContent.innerHTML='';}};
}

/* æ–°å¢å–®å­— */
document.getElementById('btnCreate').onclick=()=>{
  const w=prompt('è¼¸å…¥å–®å­—:'); if(!w)return;
  const m=prompt('è¼¸å…¥è§£é‡‹:'); if(!m)return;
  const ex=cards.find(c=>c.word===w);
  if(ex)ex.meaning=m; else cards.push({word:w,meaning:m,correct:0,sentences:[]});
  refresh();
};
/* æ–°å¢ä¾‹å¥ */
document.getElementById('btnSentence').onclick=()=>{
  if(!cards.length){alert('æ²’æœ‰å¡');return;}
  const w=prompt('è¼¸å…¥æ—¢æœ‰å–®å­—:'); const card=cards.find(c=>c.word===w);
  if(!card){alert('æ‰¾ä¸åˆ°å–®å­—');return;}
  const s=prompt('è¼¸å…¥ä¾‹å¥ï¼ˆä»¥ç©ºç™½åˆ†è©ï¼‰:'); if(!s)return;
  const pos=parseInt(prompt('å–®å­—åœ¨å¥ä¸­çš„ä½ç½®ï¼ˆ1-basedï¼‰:'),10);
  if(!pos||pos<1){alert('ä½ç½®éŒ¯èª¤');return;}
  card.sentences.push({text:s,pos});
  save(); refresh();
};
/* åŒ¯å‡ºåŒ¯å…¥æ¸…ç©º */
document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify(cards,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='flashcards.json';a.click();
};
document.getElementById('btnImport').onclick=()=>{
  const t=prompt('è²¼ä¸ŠJSONè³‡æ–™:'); if(!t)return;
  try{cards=JSON.parse(t);save();refresh();}catch(e){alert('æ ¼å¼éŒ¯èª¤');}
};
document.getElementById('btnClear').onclick=()=>{
  if(confirm('ç¢ºå®šæ¸…ç©ºï¼Ÿ')){cards=[];save();refresh();}
};

/* æ¸¬é©— */
const testModal=document.getElementById('testModal');
const qPrompt=document.getElementById('qPrompt');
const qAnswer=document.getElementById('qAnswer');
const testStatus=document.getElementById('testStatus');
let current=null;

function pickQuestion(){
  const card=cards[Math.floor(Math.random()*cards.length)];
  const hasSent=card.sentences?.length;
  const types=[0,1].concat(hasSent?[2]:[]);
  const type=types[Math.floor(Math.random()*types.length)];
  if(type===0)return{type,card,prompt:`è«‹è¼¸å…¥ä¸‹åˆ—å–®å­—çš„è§£é‡‹ï¼š\n${card.word}`,answer:card.meaning};
  if(type===1)return{type,card,prompt:`è«‹è¼¸å…¥ä¸‹åˆ—è§£é‡‹çš„å–®å­—ï¼š\n${card.meaning}`,answer:card.word};
  const s=card.sentences[Math.floor(Math.random()*card.sentences.length)];
  const tokens=s.text.split(/\s+/); const idx=s.pos-1;
  if(idx<0||idx>=tokens.length)return{type:1,card,prompt:`è«‹è¼¸å…¥ä¸‹åˆ—è§£é‡‹çš„å–®å­—ï¼š\n${card.meaning}`,answer:card.word};
  const masked=[...tokens];masked[idx]='***';
  return{type,card,prompt:`è«‹è£œä¸Š *** çš„å–®å­—ï¼š\n${masked.join(' ')}`,answer:tokens[idx],sentence:s};
}

function nextQ(){
  if(!cards.length){alert('å¡çµ„ç©º');hideTest();return;}
  current=pickQuestion();
  qPrompt.textContent=current.prompt;
  qAnswer.value='';
  qAnswer.focus();
  testStatus.textContent=`å‰©é¤˜å¡:${cards.length}`;
}

function showTest(){if(!cards.length){alert('æ²’æœ‰å¡');return;}testModal.style.display='flex';nextQ();}
function hideTest(){testModal.style.display='none';}

document.getElementById('btnTest').onclick=showTest;
document.getElementById('endTestBtn').onclick=()=>{hideTest();};
document.getElementById('skipAnswer').onclick=()=>{if(!current)return;alert('ç­”æ¡ˆ:'+current.answer);nextQ();};

document.getElementById('submitAnswer').onclick=()=>{
  if(!current)return;
  const ans=qAnswer.value.trim();
  if(ans===current.answer){
    current.card.correct=(current.card.correct||0)+1;
    if(current.card.correct>=MAX_CORRECT){cards.splice(cards.indexOf(current.card),1);alert('ç­”å°é”ä¸Šé™ï¼Œåˆªé™¤è©²å¡');}
    else alert('ç­”å°ï¼ç›®å‰åˆ†æ•¸:'+current.card.correct);
  }else{
    /* ğŸ”§ é€™è£¡æ˜¯ä¿®æ”¹ï¼šç­”éŒ¯æ‰£1ï¼Œå¯ç‚ºè²  */
    current.card.correct=(current.card.correct||0)-1;
    if(current.type===2)alert('ç­”éŒ¯ã€‚æ­£ç¢ºä¾‹å¥ï¼š\n'+current.sentence.text+'\nç›®å‰åˆ†æ•¸:'+current.card.correct);
    else alert('ç­”éŒ¯ã€‚æ­£ç¢ºç­”æ¡ˆï¼š'+current.answer+'\nç›®å‰åˆ†æ•¸:'+current.card.correct);
  }
  save();refresh();nextQ();
};

refresh();
</script>
</body>
</html>
