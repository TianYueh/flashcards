<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>單字卡 PWA</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#2b7cff">
<style>
  :root{--bg:#f6f8fb;--card:#fff;--accent:#2b7cff;--muted:#666;}
  *{box-sizing:border-box}
  body{font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial;margin:0;background:var(--bg);color:#111;}
  header{background:var(--accent);color:#fff;padding:14px 16px;}
  header h1{margin:0;font-size:18px;}
  .app{display:flex;flex-direction:column;height:calc(100vh - 56px);}
  .main{display:flex;flex:1;gap:12px;padding:12px;}
  .col{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
  .left{flex:1;min-width:160px;max-width:360px;display:flex;flex-direction:column;}
  .right{flex:2;display:flex;flex-direction:column;}
  .list{flex:1;overflow:auto;margin-bottom:8px;}
  .card-item{padding:8px;border-radius:8px;cursor:pointer;margin-bottom:6px;border:1px solid rgba(0,0,0,0.04);}
  .card-item.small{font-size:13px;color:var(--muted);}
  .controls{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;}
  button{background:var(--accent);color:#fff;border:none;padding:8px 10px;border-radius:8px;font-weight:600;cursor:pointer;}
  button.ghost{background:#eef4ff;color:var(--accent);font-weight:600;border:1px solid rgba(43,124,255,0.12);}
  label{display:block;font-size:13px;margin-top:8px;color:var(--muted)}
  input[type="text"],textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #e0e6ef;margin-top:6px;font-size:14px}
  textarea{resize:vertical}
  .detail{overflow:auto;flex:1}
  .prompt{background:#f2f6ff;padding:10px;border-radius:8px;margin-bottom:8px}
  .status{font-size:13px;color:var(--muted);margin-top:8px}
  .center{display:flex;gap:8px;align-items:center}
  footer{padding:8px 12px;font-size:13px;color:var(--muted);text-align:center}
  #modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);align-items:center;justify-content:center;padding:16px}
  #modalInner{background:#fff;border-radius:12px;padding:12px;max-width:680px;width:100%;box-shadow:0 8px 24px rgba(0,0,0,0.3)}
  .modal-row{margin-top:8px}
  .q-prompt{white-space:pre-wrap;background:#fafcff;padding:10px;border-radius:8px;margin-bottom:6px}
  @media(max-width:720px){.main{flex-direction:column;padding:10px}.left{max-width:none}}
</style>
</head>
<body>
<header><h1>單字卡 App（PWA）</h1></header>
<div class="app">
  <div class="main">
    <div class="col left">
      <div class="controls">
        <button id="btnCreate">建立單字</button>
        <button id="btnSentence" class="ghost">新增例句</button>
        <button id="btnTest" class="ghost">開始測驗</button>
      </div>
      <div class="list" id="cardsList" aria-label="單字清單"></div>
      <div class="status" id="status"></div>
    </div>

    <div class="col right">
      <div id="detailArea" class="detail">
        <div class="prompt"><strong>使用說明：</strong> 點選左側卡片檢視與管理。建立或新增例句後會自動儲存。測驗題型隨機：單字→解釋、解釋→單字、例句遮蔽。答錯會扣 1 分（可為負），答對達 5 次會刪除該卡。</div>
        <div id="detailContent"></div>
      </div>
      <div style="margin-top:10px" class="center">
        <button id="btnExport" class="ghost">匯出 JSON</button>
        <button id="btnImport" class="ghost">匯入 JSON</button>
        <button id="btnClear" class="ghost">清空所有</button>
      </div>
    </div>
  </div>

  <!-- 測驗 modal -->
  <div id="testModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;padding:16px">
    <div style="background:#fff;border-radius:12px;padding:12px;max-width:680px;width:100%;box-shadow:0 8px 24px rgba(0,0,0,0.3)">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>測驗模式</strong>
        <button id="endTestBtn" class="ghost">結束測驗</button>
      </div>
      <div class="q-prompt" id="qPrompt">題目會出現在這裡</div>
      <input id="qAnswer" type="text" placeholder="輸入答案後按提交" />
      <div style="margin-top:8px;display:flex;gap:8px">
        <button id="submitAnswer">提交答案</button>
        <button id="skipAnswer" class="ghost">跳過</button>
      </div>
      <div style="margin-top:8px;color:#666" id="testStatus"></div>
    </div>
  </div>

  <footer>加入主畫面可離線使用。資料儲存在你的裝置。</footer>
</div>

<script>
const STORAGE_KEY='flashcards_v1';
const MAX_CORRECT=5;
let cards=JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
function save(){localStorage.setItem(STORAGE_KEY,JSON.stringify(cards));}
function escapeHtml(s){return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}
const listEl=document.getElementById('cardsList');
const detailContent=document.getElementById('detailContent');
const status=document.getElementById('status');
let selected=null;
function refresh(){
  listEl.innerHTML='';
  cards.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='card-item';
    el.innerHTML=`<div><strong>${escapeHtml(c.word)}</strong> (${c.correct||0})<div class="small">${escapeHtml(c.meaning)}</div></div>`;
    el.onclick=()=>{selected=i;showDetail(c);highlight();};
    listEl.appendChild(el);
  });
  status.textContent=`共有 ${cards.length} 張卡`;
  save();
}
function highlight(){Array.from(listEl.children).forEach((el,i)=>el.style.border=i===selected?'1px solid var(--accent)':'1px solid rgba(0,0,0,0.04)');}
function showDetail(c){
  let html=`<h3>${escapeHtml(c.word)} <small>(答對:${c.correct||0})</small></h3>`;
  html+=`<p><strong>解釋：</strong>${escapeHtml(c.meaning)}</p>`;
  if(c.sentences?.length){
    html+='<ol>'+c.sentences.map(s=>`<li>${escapeHtml(s.text)} (pos=${s.pos})</li>`).join('')+'</ol>';
  }else html+='<p style="color:#888">無例句</p>';
  html+=`<button id="delBtn" class="ghost">刪除此卡</button>`;
  detailContent.innerHTML=html;
  document.getElementById('delBtn').onclick=()=>{if(confirm('確定刪除？')){cards.splice(selected,1);selected=null;refresh();detailContent.innerHTML='';}};
}

/* 新增單字 */
document.getElementById('btnCreate').onclick=()=>{
  const w=prompt('輸入單字:'); if(!w)return;
  const m=prompt('輸入解釋:'); if(!m)return;
  const ex=cards.find(c=>c.word===w);
  if(ex)ex.meaning=m; else cards.push({word:w,meaning:m,correct:0,sentences:[]});
  refresh();
};
/* 新增例句 */
document.getElementById('btnSentence').onclick=()=>{
  if(!cards.length){alert('沒有卡');return;}
  const w=prompt('輸入既有單字:'); const card=cards.find(c=>c.word===w);
  if(!card){alert('找不到單字');return;}
  const s=prompt('輸入例句（以空白分詞）:'); if(!s)return;
  const pos=parseInt(prompt('單字在句中的位置（1-based）:'),10);
  if(!pos||pos<1){alert('位置錯誤');return;}
  card.sentences.push({text:s,pos});
  save(); refresh();
};
/* 匯出匯入清空 */
document.getElementById('btnExport').onclick=()=>{
  const blob=new Blob([JSON.stringify(cards,null,2)],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='flashcards.json';a.click();
};
document.getElementById('btnImport').onclick=()=>{
  const t=prompt('貼上JSON資料:'); if(!t)return;
  try{cards=JSON.parse(t);save();refresh();}catch(e){alert('格式錯誤');}
};
document.getElementById('btnClear').onclick=()=>{
  if(confirm('確定清空？')){cards=[];save();refresh();}
};

/* 測驗 */
const testModal=document.getElementById('testModal');
const qPrompt=document.getElementById('qPrompt');
const qAnswer=document.getElementById('qAnswer');
const testStatus=document.getElementById('testStatus');
let current=null;

function pickQuestion(){
  const card=cards[Math.floor(Math.random()*cards.length)];
  const hasSent=card.sentences?.length;
  const types=[0,1].concat(hasSent?[2]:[]);
  const type=types[Math.floor(Math.random()*types.length)];
  if(type===0)return{type,card,prompt:`請輸入下列單字的解釋：\n${card.word}`,answer:card.meaning};
  if(type===1)return{type,card,prompt:`請輸入下列解釋的單字：\n${card.meaning}`,answer:card.word};
  const s=card.sentences[Math.floor(Math.random()*card.sentences.length)];
  const tokens=s.text.split(/\s+/); const idx=s.pos-1;
  if(idx<0||idx>=tokens.length)return{type:1,card,prompt:`請輸入下列解釋的單字：\n${card.meaning}`,answer:card.word};
  const masked=[...tokens];masked[idx]='***';
  return{type,card,prompt:`請補上 *** 的單字：\n${masked.join(' ')}`,answer:tokens[idx],sentence:s};
}

function nextQ(){
  if(!cards.length){alert('卡組空');hideTest();return;}
  current=pickQuestion();
  qPrompt.textContent=current.prompt;
  qAnswer.value='';
  qAnswer.focus();
  testStatus.textContent=`剩餘卡:${cards.length}`;
}

function showTest(){if(!cards.length){alert('沒有卡');return;}testModal.style.display='flex';nextQ();}
function hideTest(){testModal.style.display='none';}

document.getElementById('btnTest').onclick=showTest;
document.getElementById('endTestBtn').onclick=()=>{hideTest();};
document.getElementById('skipAnswer').onclick=()=>{if(!current)return;alert('答案:'+current.answer);nextQ();};

document.getElementById('submitAnswer').onclick=()=>{
  if(!current)return;
  const ans=qAnswer.value.trim();
  if(ans===current.answer){
    current.card.correct=(current.card.correct||0)+1;
    if(current.card.correct>=MAX_CORRECT){cards.splice(cards.indexOf(current.card),1);alert('答對達上限，刪除該卡');}
    else alert('答對！目前分數:'+current.card.correct);
  }else{
    /* 🔧 這裡是修改：答錯扣1，可為負 */
    current.card.correct=(current.card.correct||0)-1;
    if(current.type===2)alert('答錯。正確例句：\n'+current.sentence.text+'\n目前分數:'+current.card.correct);
    else alert('答錯。正確答案：'+current.answer+'\n目前分數:'+current.card.correct);
  }
  save();refresh();nextQ();
};

refresh();
</script>
</body>
</html>
